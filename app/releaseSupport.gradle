import java.util.regex.Pattern

task increaseVersionCode {
    def currentVersionCode = 0
    def newVersionCode = 0

    def buildFile = new File("app/build.gradle")
    def contentFile = buildFile.getText("UTF-8")

    def regex = "versionCode\\s[\\t]*([^\\n\\r]*)"
    def versionCodeRex = Pattern.compile(regex, Pattern.MULTILINE).matcher(contentFile)

    while (versionCodeRex.find()) {
        currentVersionCode = versionCodeRex.group(1)
    }

    if (project.hasProperty("versionCodeInput")) {
        newVersionCode = versionCodeInput
    } else {
        newVersionCode = Integer.parseInt(currentVersionCode) + 1
    }


    doLast {
        buildFile.text = contentFile.replaceFirst("versionCode\\s[\\t]*([0-9]*)", "versionCode " + newVersionCode)
        println "Increase version code success: " + newVersionCode
    }
}

def readFile = {
    def versionCode = 0
    def versionName = 0

    def buildFile = new File("app/build.gradle")
    def contentFile = buildFile.getText("UTF-8")

    def versionCodePattern = "versionCode\\s[\\t]*([^\\n\\r]*)"
    def versionCodeRex = Pattern.compile(versionCodePattern, Pattern.MULTILINE).matcher(contentFile)

    while (versionCodeRex.find()) {
        versionCode = versionCodeRex.group(1)
    }

    def versionNamePattern = "versionName\\s[\\t]*([^\\n\\r]*)"
    def versionNameRex = Pattern.compile(versionNamePattern, Pattern.MULTILINE).matcher(contentFile)

    while (versionNameRex.find()) {
        versionName = versionNameRex.group(1)
    }

    return [contentFile, versionCode, versionName.replaceAll("\"", "")]
}

task increaseVersionName {
    def versions = readFile()

    def contentFile = versions[0]
    def currentVersionCode = versions[1]
    def currentVersionName = versions[2]
    def newVersionName = "1.x.x"
    def major
    def minor
    def patch

    println currentVersionName
    println currentVersionCode


    def splitVersionName = currentVersionName.split("[.]")
    major = splitVersionName[0]
    minor = splitVersionName[1]
    patch = splitVersionName[2]


    if (project.hasProperty("versionNameInput")) {
        newVersionName = versionNameInput
    } else {
        if (project.hasProperty("major")) {
            major = Integer.parseInt(major) + 1
        } else if (project.hasProperty("patch")) {
            patch = Integer.parseInt(patch) + 1
        } else {
            minor = Integer.parseInt(minor) + 1
        }

        newVersionName = major + "." + minor + "." + patch
    }

    doLast {
        buildFile.text = contentFile.replaceFirst("versionName\\s\"[0-9.]*\"", "versionName " + "\"" + newVersionName + "\"")
        def messageCommit = "Increase version to " + newVersionName + "." + currentVersionCode
        println messageCommit

        if (project.hasProperty("pushCode") && project.hasProperty("branchPush")) {
            ['sh', '-c', 'git add .'].execute().text.trim()
            ['sh', '-c', 'git commit -m ' + '\"' + messageCommit + '\"'].execute().text
            ['sh', '-c', 'git push origin ' + branchPush].execute().text

            print "Commit and push code at branch $branchPush"
        }
    }
}
